---
title: "aula_22_08"
format: html
editor: visual
---

# Aula do dia 22/05/2025 Elaborando a Matriz de dados para CAPM 5ativos

```{r}
#Baixando os dados da selic:
library(rbcb)

selic <- get_series(11, start_date = dataini,end_date =datafim);selic 
library(zoo)
Selic=zoo(selic$'11')
index(Selic)=selic$date
Selic;plot(Selic) 

```

```{r}
Basico<-data.frame(na.omit(merge(lwsa3, elet6, itsa4, rent3, brfs3)));Basico
names(Basico)<-c("lwsa3", "elet6", "itsa4", "rent3", "brfs3");Basico;length(brfs3)
write.table(Basico,file="Basico.txt")

dados<-read.table("Basico.txt", head=T);dados
dados <- timeSeries(dados)
dados

Retornos<-returns(dados);Retornos
View(data.frame(Retornos))
require(fPortfolio)

```

### Elaborando a matriz de dados para 5 ativos

```{r}
dados2=na.omit(merge(ibov,Selic))
dados2=data.frame(index(dados2), dados2)
names(dados2)=c("Data", "Ibovespa", "SELIC")
attach(dados2); 
dados2

library(zoo)
Ativos=merge(lwsa3,elet6,itsa4,rent3,brfs3,ibov,Selic)
length(na.omit(Ativos[,1]))
Data1=index(na.omit(Ativos));length(Data1)

CarteiraBETA=data.frame(na.omit(Ativos),na.omit(Data1))
names(CarteiraBETA)=c("lwsa3","elet6","itsa4","rent3","brfs3","Ibovespa","Selic", "Data1")
attach(CarteiraBETA)
options(max.print=99999)
CarteiraBETA
n=length(CarteiraBETA[,1]); n
CarteiraBETA[n,]
write.table(CarteiraBETA, file="BetaCarteira.txt")
```

```{r}
CarteiraBETA<-read.table("BetaCarteira.txt", head=T)
names(CarteiraBETA)<-c("lwsa3","elet6","itsa4","rent3","brfs3","ibovespa","Selic", "Data")
attach(CarteiraBETA)
CarteiraBETA; length((CarteiraBETA$Selic))

CarteiraBETA$ibovespa;length(CarteiraBETA$ibovespa)
CarteiraBETA$lwsa3;length(CarteiraBETA$lwsa3)
CarteiraBETA$Selic;length(CarteiraBETA$Selic)

ribov=diff(log(ibovespa));ribov;length(ribov)
Ribov=ribov*100;Ribov;mean(Ribov)
RSelic=CarteiraBETA$Selic[-1];length(CarteiraBETA$Selic[-1])
RSelic

rlwsa3=diff(log(CarteiraBETA$lwsa3[-1]));length(CarteiraBETA$lwsa3[-1])
relet6=diff(log(CarteiraBETA$elet6[-1]));length(CarteiraBETA$elet6[-1])
ritsa4=diff(log(CarteiraBETA$itsa4[-1]));length(CarteiraBETA$itsa4[-1])
rrent3=diff(log(CarteiraBETA$rent3[-1]));length(CarteiraBETA$rent3[-1])
rbrfs3=diff(log(CarteiraBETA$brfs3[-1]));length(CarteiraBETA$brfs3[-1])

#RIbov=(rIbov-Selic[-1])
Ribov=(ribov-RSelic);length(Ribov);Ribov
Rlwsa3=rlwsa3-RSelic[-1]
Rlwsa3;length(Rlwsa3)
Relet6=relet6-RSelic[-1]
Ritsa4=ritsa4-RSelic[-1]
Rrent3=rrent3-RSelic[-1]
Rbrfs3=rbrfs3-RSelic[-1]
```

```{r}
CarteiraBETA<-read.table("BetaCarteira.txt", head=T)
names(CarteiraBETA)<-c("lwsa3","elet6","itsa4","rent3","brfs3","ibovespa","Selic", "Data")
attach(CarteiraBETA)
CarteiraBETA; length((CarteiraBETA$Selic))

CarteiraBETA$ibovespa;length(CarteiraBETA$ibovespa)
CarteiraBETA$lwsa3;length(CarteiraBETA$lwsa3)
CarteiraBETA$Selic;length(CarteiraBETA$Selic)

ribov=diff(log(ibovespa));ribov;length(ribov)
Ribov=ribov*100;Ribov;mean(Ribov)
RSelic=CarteiraBETA$Selic[-1];length(CarteiraBETA$Selic[-1])
RSelic

rlwsa3=diff(log(CarteiraBETA$lwsa3[-1]));length(CarteiraBETA$lwsa3[-1])
relet6=diff(log(CarteiraBETA$elet6[-1]));length(CarteiraBETA$elet6[-1])
ritsa4=diff(log(CarteiraBETA$itsa4[-1]));length(CarteiraBETA$itsa4[-1])
rrent3=diff(log(CarteiraBETA$rent3[-1]));length(CarteiraBETA$rent3[-1])
rbrfs3=diff(log(CarteiraBETA$brfs3[-1]));length(CarteiraBETA$brfs3[-1])

#RIbov=(rIbov-Selic[-1])
Ribov=(ribov-RSelic);length(Ribov);Ribov
Rlwsa3=rlwsa3-RSelic[-1]
Rlwsa3;length(Rlwsa3)
Relet6=relet6-RSelic[-1]
Ritsa4=ritsa4-RSelic[-1]
Rrent3=rrent3-RSelic[-1]
Rbrfs3=rbrfs3-RSelic[-1]

#Cálculo do Beta vivt3 (+...)------------------------------------------------------------------------------------------------------

Betalwsa3=lm(Rlwsa3~Ribov[-1])
Betalwsa3
Betaelet6=lm(Relet6~Ribov[-1]);Betaelet6
Betaitsa4=lm(Ritsa4~Ribov[-1]);Betaitsa4
Betarent3=lm(Rrent3~Ribov[-1]);Betarent3
Betabrfs3=lm(Rbrfs3~Ribov[-1]);Betabrfs3

#### Testes Econométricos - Hipóteses do MQO
##
{
  #Ativo1
  coef(Betalwsa3)
  library(lmtest)
  coeftest(Betalwsa3)
  summary(Betalwsa3) 
  
  residuos<-residuals(Betalwsa3)
  residuos
  plot(residuos, type="l", col="red")
  abline(h=0, col="blue", lw=3)
  hist(residuos, main="", col="cadetblue", prob=T, xlab = names(residuos)[1], breaks = 30)
  curve(expr=dnorm(x,mean=mean(residuos),sd=sd(residuos)),col="red",add= TRUE, lwd=2)
  
  require(fBasics)
  jarqueberaTest(residuos)
  qqnorm(residuos, col="blue")
  qqline(residuos, col="red")
  shapiro.test(residuos)
  
  library(lmtest)
  coeftest(Betalwsa3)
  length(residuos);length(residuos)*0.15
  gqtest(Betalwsa3, fraction=8, alternative = "greater")
  bptest(Betalwsa3)
  library(whitestrap)
  white_test(Betalwsa3)
  dwtest(Betalwsa3)
  library(FinTS)
  ArchTest(residuos, lags = 2)
  
  Box.test(residuos, lag=12, type="Box-Pierce")




```

```{r}
CarteiraBETA<-read.table("BetaCarteira.txt", head=T)
names(CarteiraBETA)<-c("lwsa3","elet6","itsa4","rent3","brfs3","ibovespa","Selic", "Data")
attach(CarteiraBETA)
CarteiraBETA; length((CarteiraBETA$Selic))

CarteiraBETA$ibovespa;length(CarteiraBETA$ibovespa)
CarteiraBETA$elet6;length(CarteiraBETA$elet6)
CarteiraBETA$Selic;length(CarteiraBETA$Selic)

ribov=diff(log(ibovespa));ribov;length(ribov)
Ribov=ribov*100;Ribov;mean(Ribov)
RSelic=CarteiraBETA$Selic[-1];length(CarteiraBETA$Selic[-1])
RSelic

rlwsa3=diff(log(CarteiraBETA$lwsa3[-1]));length(CarteiraBETA$lwsa3[-1])
relet6=diff(log(CarteiraBETA$elet6[-1]));length(CarteiraBETA$elet6[-1])
ritsa4=diff(log(CarteiraBETA$itsa4[-1]));length(CarteiraBETA$itsa4[-1])
rrent3=diff(log(CarteiraBETA$rent3[-1]));length(CarteiraBETA$rent3[-1])
rbrfs3=diff(log(CarteiraBETA$brfs3[-1]));length(CarteiraBETA$brfs3[-1])

#RIbov=(rIbov-Selic[-1])
Ribov=(ribov-RSelic);length(Ribov);Ribov
Rlwsa3=rlwsa3-RSelic[-1]
Rlwsa3;length(Rlwsa3)
Relet6=relet6-RSelic[-1]
Ritsa4=ritsa4-RSelic[-1]
Rrent3=rrent3-RSelic[-1]
Rbrfs3=rbrfs3-RSelic[-1]

#Cálculo do Beta vivt3 (+...)------------------------------------------------------------------------------------------------------

Betalwsa3=lm(Rlwsa3~Ribov[-1])
Betalwsa3
Betaelet6=lm(Relet6~Ribov[-1]);Betaelet6
Betaitsa4=lm(Ritsa4~Ribov[-1]);Betaitsa4
Betarent3=lm(Rrent3~Ribov[-1]);Betarent3
Betabrfs3=lm(Rbrfs3~Ribov[-1]);Betabrfs3

#### Testes Econométricos - Hipóteses do MQO
##
{
  #Ativo2
  coef(Betaelet6)
  library(lmtest)
  coeftest(Betaelet6)
  summary(Betaelet6) 
  
  residuos<-residuals(Betaelet6)
  residuos
  plot(residuos, type="l", col="red")
  abline(h=0, col="blue", lw=3)
  hist(residuos, main="", col="cadetblue", prob=T, xlab = names(residuos)[1], breaks = 30)
  curve(expr=dnorm(x,mean=mean(residuos),sd=sd(residuos)),col="red",add= TRUE, lwd=2)
  
  require(fBasics)
  jarqueberaTest(residuos)
  qqnorm(residuos, col="blue")
  qqline(residuos, col="red")
  shapiro.test(residuos)
  
  library(lmtest)
  coeftest(Betaelet6)
  length(residuos);length(residuos)*0.15
  gqtest(Betaelet6, fraction=8, alternative = "greater")
  bptest(Betaelet6)
  library(whitestrap)
  white_test(Betaelet6)
  dwtest(Betaelet6)
  library(FinTS)
  ArchTest(residuos, lags = 2)
  
  Box.test(residuos, lag=12, type="Box-Pierce")



```

```{r}
ativos <- c("lwsa3","elet6","itsa4","rent3","brfs3")
resultados <- data.frame(Ativo = ativos, Beta = NA, Alpha = NA, R2 = NA)

for(i in 1:length(ativos)){
  Rativo <- diff(log(CarteiraBETA[[ativos[i]]])) - CarteiraBETA$Selic[-1]
  dados <- data.frame(Rativo, Ribov)
  modelo <- lm(Rativo ~ Ribov, data = dados)
  resultados$Beta[i] <- coef(modelo)[2]
  resultados$Alpha[i] <- coef(modelo)[1]
  resultados$R2[i] <- summary(modelo)$r.squared
}

resultados

```
